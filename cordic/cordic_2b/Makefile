# This makefile was tested with Vivado HLS 2019.2
# and Vitis v2024.1
#
# select the HLS compiler to use (vivado_hls or vitis)
TOP = cordiccart2pol

USE_VITIS=1

# -------- Python chooser (works on Win/MINGW & Linux) --------
# Try python, else py (Windows launcher). Fail clearly otherwise.
PYTHON := $(shell command -v python 2>/dev/null)
ifeq ($(strip $(PYTHON)),)
  PYTHON := $(shell command -v py 2>/dev/null)
endif
ifeq ($(strip $(PYTHON)),)
  $(error Could not find Python. Install Python 3 and ensure 'python' or 'py' is on PATH.)
endif
# -------------------------------------------------------------

ifeq ($(USE_VITIS),1)

VITIS_HLS_PATH := $(shell which vitis_hls 2>/dev/null)
ifeq ($(strip $(VITIS_HLS_PATH)),)
  $(error Could not find "vitis_hls" on PATH.)
endif
VITIS_COMPILER := $(shell dirname "$(VITIS_HLS_PATH)")

ifneq (,$(findstring 2024.2,$(VITIS_HLS_PATH)))
  VHLS := $(VITIS_COMPILER)/../../../Vitis/2024.2
else
  VHLS := $(VITIS_COMPILER)/../../../Vitis_HLS/2024.1
endif

HLS_COMPILER = vitis-run --mode hls --tcl
else
VHLS := $(shell vivado_hls -r)
HLS_COMPILER = vivado_hls -f
endif

EXAMPLES_CPP = $(shell ls *_test.cpp 2>/dev/null)
EXAMPLES_BIN = $(patsubst %.cpp,%,$(EXAMPLES_CPP))
EXAMPLES_LOG = $(patsubst %.cpp,%.log,$(EXAMPLES_CPP))

CC  = gcc
CXX = g++

# insert new LD path to the LD_LIBRARY_PATH if it is not already there
LD_PATH_NEW = /usr/lib/x86_64-linux-gnu
LD_LIBRARY_PATH := $(shell echo $(value LD_LIBRARY_PATH) | grep -q $(LD_PATH_NEW) || echo $(LD_PATH_NEW):)$(value LD_LIBRARY_PATH)

# Paths (use forward slashes; quote to survive spaces/non-ASCII like "Masaüstü")
GEN_TCL         = "$(CURDIR)/../../scripts/gen_hls_runner_script.py"
HLS_CONFIG_FILE = "$(CURDIR)/__hls_config__.ini"

%.o: %.cpp
	$(CXX) -I"$(VHLS)/include" -c $< -o $@

%_test.bin: %_test.cpp %.cpp
	LD_LIBRARY_PATH=$(LD_LIBRARY_PATH) $(CXX) -I"$(VHLS)/include" $? -g -o $@

CXX_HLS_TARGET_FILES = \
	$(TOP).cpp

HLS_TARGETS = $(patsubst %.cpp,%.comp,$(CXX_HLS_TARGET_FILES))

%.comp: %.tcl
	$(HLS_COMPILER) $< || { s=$$?; echo "$(HLS_COMPILER) $< failed $$s" >&2; exit $$s; }

# *** FIX: call the Python script explicitly ***
%.tcl: %.cpp
	"$(PYTHON)" $(GEN_TCL) -c $(HLS_CONFIG_FILE) -i $< -o $@

%.log: %.bin
	./$< > $@ 2>&1 || { s=$$?; echo "./$< > $@ failed $$s" >&2; exit $$s; }

hls: $(HLS_TARGETS)

test: $(EXAMPLES_LOG)

report: hls
	cp -f $(TOP).comp/hls/syn/report/$(TOP)_csynth.rpt "$(CURDIR)" || true

clean:
	rm -rf *.o *.log *.bin *.tcl *.comp *.rpt logs hls out.dat

.PHONY: clean hls test report
.PRECIOUS: %.bin %.tcl

# --- Export IP target -------------------------------------------------

# IP'yi paketleyeceğimiz çıktı klasörü
IP_OUT_DIR := "$(CURDIR)/ip_out"

# $(TOP)_ip.tcl: mevcut jeneratörle TCL üret, sonra export komutu ekle
$(TOP)_ip.tcl: $(TOP).cpp
	"$(PYTHON)" $(GEN_TCL) -c $(HLS_CONFIG_FILE) -i $< -o $@
	@echo "export_design -format ip_catalog -rtl verilog -output $(IP_OUT_DIR)" >> $@

# ip: TCL'i çalıştır ve IP'yi üret
ip: $(TOP)_ip.tcl
	$(HLS_COMPILER) $< || { s=$$?; echo "$(HLS_COMPILER) $< failed $$s" >&2; exit $$s; }
	@echo
	@echo "✅ IP exported to: $(IP_OUT_DIR)"
	@echo

.PHONY: ip